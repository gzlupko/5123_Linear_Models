---
title: "learning_type_study"
author: "Gian Zlupko"
date: "11/11/2021"
output: html_document
---

```{r Setup, include=FALSE}
library(tidyverse) 
library(haven) 
library(psych) 
library(ggridges) 
library(car)
library(apaTables) 
setwd("/Users/gianzlupko/Desktop/5123 Linear Models/5123_Linear_Models/Online_Learning_Study")   
```

Import data and view fields
```{r Import-Data, include = FALSE}
learning <- read_dta("online_assessment.dta") 
head(learning) 
```


```{r Data-Cleaning}

# rename columns

learn2 <- learning %>%
  rename(course_grade = falsexam) 

# create column that stores character string identifying course type: 
learn2 <- learn2 %>%
  mutate(format_type = 
           ifelse(format_ol == 1, "online", 
                  ifelse(format_blended == 1, "hybrid", 
                         ifelse(format_ol == 0 & format_blended == 0, 
                                "traditional", "NA")))) 


# store format type as factor: 
learn2$format_type <- as.factor(learn2$format_type) 
levels(learn2$format_type) 

```


A review of missing data
```{r Missing-Data}

# attrition by instructional mode: 
# note, Alpert et al. (2016) coded drop out data 
# 1 = students given permission at outset of semester but did not sign up
# 2 = students who did enroll that later dropped out
# 3 = students who completed the course 

attrition <- learn2 %>%
  group_by(enroll_count) %>%
  select(format_type, enroll_count) %>%
  table() %>%
  data.frame()

#write.csv(attrition, "attrition_by_condition.csv") 
online_attrition = (29 + 50)
online_attrition/172

# store new data with only those who completed the course 

completed_course <- learn2 %>%
  filter(enroll_count == 3) 

# count n-size for course completion across experimental conditions 

completed_course %>%
  group_by(format_type) %>% 
  count(format_type) 


# check missigness of GPA (covariate): 
# for those that completed coourse, 48 GPA records missing total
gpa_missing <- completed_course %>%
  select(format_type, gpa) %>%
  group_by(format_type) %>%
  filter(is.na(gpa)) %>%
  count(format_type)

# filter data set for subset with complete prior GPA records 
completed <- completed_course %>% 
  filter(!is.na(gpa)) 



```



Assumptions for ANOVA

```{r}

# constant variance - Maxwell et al. (2017)'s variance ratio: 
# step 1: calculate variance by group

completed %>%
  group_by(format_type) %>%
  summarise(variance = var(course_grade))
completed %>%
  group_by(format_type) %>%
  count(format_type)
  
maxwell_ratio <- (96*229.705) / (85*79.31)
maxwell_ratio
(maxwell_ratio < 4) 
# true; variance ratio is less than 4, so we have evidence for constant variance

# next, conduct Levene's test of homogeneity of variance 
lm1 <- lm(course_grade ~ format_type, data = completed) 
library(car)
leveneTest(lm1)

# visualize group variances with boxplot 
ggplot(data = completed, 
       aes(format_type, course_grade, fill = format_type)) + 
  geom_boxplot() + coord_flip() + ylab(label = "Final Course Grade") + 
  xlab("Instructional Format")+ labs(fill = "Class Format") +  
  theme(legend.position = "none")


# test assumption of normality with QQ-Plot 
qqPlot(lm1)

# outliers in data set 
completed %>%
  select(course_grade) %>%
  arrange(course_grade)

# test assumption of normality with histograms or distribution plots 

ggplot(data = completed, aes(x = course_grade)) +
  geom_histogram(fill = "white", colour = "black") +
  facet_grid(format_type ~ .) + xlab("Final Course Grade") + 
  ylab("Count")

# distribution plots for final course grade by instructional format 
ggplot(data = completed, aes(x = course_grade, y = format_type)) + 
  geom_density_ridges(scale = 0.9) + scale_x_continuous(limits = c(1,100), n.breaks = 10) + 
  theme_joy() + scale_y_discrete(labels=c("Hybrid", "Online", "Traditional")) + 
  theme(legend.position = "none") + xlab("Final Course Grade") + ylab("Group")


```






Univariate graphical plots 

```{r Univariate-Plots}

# boxplot 
ggplot(data = completed_course, 
       aes(format_type, course_grade, fill = format_type)) + 
  geom_boxplot() + coord_flip() + ylab(label = "Final Grade") + 
  xlab("Class Format")+ labs(fill = "Class Format") +
  scale_x_discrete(labels=c("Traditional", "Online", "Hybrid")) 


ggplot(data = completed_course, 
       aes(course_grade, fill = format_type)) + geom_histogram()

# final grades by group histogram 
ggplot(data = completed_course, aes(x = course_grade)) +
  geom_histogram(fill = "white", colour = "black") +
  facet_grid(format_type ~ .) + xlab("Final Grade") + 
  ylab("Count")


# GPA by group 
ggplot(data = completed_course, aes(x = gpa)) +
  geom_histogram(fill = "white", colour = "black") +
  facet_grid(format_type ~ .) + xlab("GPA") + 
  ylab("Count") + stat_bin(bins = 8) 

# GPA distributions by group 

ggplot(data = completed, aes(x = course_grade, y = format_type)) + 
  geom_joy(scale = 0.9) + 
  theme_joy() + scale_y_discrete(labels=c("Hybrid", "Online", "Traditional")) + 
  scale_x_continuous(breaks = seq(min(completed$course_grade), max(completed$course_grade), by = 10)) + 
  theme(legend.position = "none") + 
  xlab("Final Course Grade") + ylab("Instructional Format") 


# QQ plot of grades to test normality assumption:

lm1 <- lm(course_grade ~ format_type, data = completed_course)
qqPlot(lm1)


```


```{r one-way-ANOVA}

# one-way ANOVA
lm1 <- lm(course_grade ~ format_type, data = completed) 

lm1 %>%
  summary() 

# The ANOVA Source Table
apa.aov.table(lm1, filename = "ANOVA_APA.rtf", table.number = 2)

```


Assumptions for covariate

```{r covariate-assumptions}

# 1. demonstrate strong correlation b/w covariate and outcome 
# and that they are significantly related 
lm(course_grade ~ gpa, data = completed) %>%
  summary() 


# Next, ensure that the cov-outcome relationship is linear 
# To do so, visually inspect a scatterplot and confirm whether it indicates a linear relationship 
# using a limited view of x-axis; there were a few extreme outliers
# zooming in on a more limited view allows us to more closely visually inspect that relationship is linear 
plot(x = completed$course_grade, y = completed$gpa)
ggplot(data = completed, aes(x = course_grade, y = gpa)) + geom_point() + 
  scale_x_continuous(limits = c(50, 100))  

# 2. covariate balance 



# 3. treatment by covariate interaction 
# ANCOVA also assumes no treatment by covariate interaction 
# to test for this, add an interaction term to regression model 
# ensure that interaction is not significant (e.g. constant effect of gpa for all values of course grade)

lm_cov_interaction <- lm(course_grade ~ format_type + gpa + gpa:course_grade, 
                         data = completed)

summary(lm_cov_interaction) 

```





```{r Descriptive-Statistics}

# final grade & GPA descriptive stats by group 
grade_desc <- describeBy(completed_course$course_grade, 
                         completed_course$format_type, mat = TRUE) 
gpa_desc <- describeBy(completed_course$gpa, 
           completed_course$format_type, mat = TRUE) 

#write.csv(grade_desc, "grade_descriptives.csv") 
#write.csv(gpa_desc, "gpa_descriptives.csv") 

```





Test for covariate suitability 

Is GPA an appropriate covariate to be used in ANCOVA? 

```{r}
# first, assess whether relationship between covariate and DV is strong (r greater than .3)
cor(completed$gpa, completed$falsexam)

lm(falsexam ~ gpa, data = completed) %>%
  summary()

ggplot(data = completed, aes(x = gpa, y = falsexam)) + geom_point() 

```




